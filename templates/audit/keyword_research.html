{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}  <!-- Load static files -->

{% block content %}
    <!-- Include Font Awesome for Edit Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-yH2Br+HtIsVJzObX5fNRb/Ot7DRSuhxSjE6lE6FVHIbvc6im1cB/3H0tUv0D4OmGiDhZyVY3cXkGgFum0BvBtA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="{% static 'css/keyword_research.css' %}" />

    <!-- Define JavaScript variables -->
    <script>
        // Define the URL for updating keyword fields
        const updateKeywordFieldUrl = "{% url 'update_keyword_field' %}";
    </script>

    <div class="container mx-auto px-4 py-8">
        <h2 class="text-xl font-bold mb-4 text-white">Keyword Research Table</h2>

        <!-- Rows per page dropdown -->
        <form method="GET">
            <div class="flex justify-end mb-4">
                <label for="per_page" class="mr-2 text-white">Rows per page:</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="bg-gray-700 text-gray-200 rounded">
                    {% for option in per_page_options %}
                        <option value="{{ option }}" {% if per_page == option|stringformat:"s" %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>

        <!-- Table Rendering -->
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto">
                <thead>
                    <tr>
                        {% for column in table.columns %}
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-200 
                                       {% if column.name in 'action_choice url' %} sticky left-0 z-10 bg-gray-800 {% endif %} whitespace-nowrap">
                                {{ column.header }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table.page.object_list %}
                        <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                            {% for column, cell in row.items %}
                                <td class="px-6 py-4 text-sm text-gray-200 
                                           {% if column.name in 'action_choice url' %} sticky left-0 z-10 bg-gray-800 {% endif %} whitespace-nowrap relative">
                                    {% if column.name in 'primary_keyword pk_volume pk_ranking' %}
                                        <span
                                            class="editable-span single-line bg-transparent text-gray-200 focus:outline-none relative inline-block"
                                            contenteditable="true"
                                            data-id="{{ row.record.id }}" 
                                            data-field="{{ column.name }}"
                                            data-placeholder="Click to add {{ column.verbose_name|lower }}"
                                            onblur="saveField(this)"
                                            onkeydown="handleKeyDown(this, event)"
                                        >
                                            {{ cell|default_if_none:''|safe }}
                                            <!-- Edit Icon -->
                                            <i class="fa fa-pencil-alt absolute right-0 top-0 mt-1 mr-2 text-gray-400 opacity-0 transition-opacity duration-200 editable-icon"></i>
                                        </span>
                                    {% elif column.name == 'secondary_keywords' %}
                                        <span
                                            class="editable-span multi-line bg-transparent text-gray-200 focus:outline-none relative inline-block"
                                            contenteditable="true"
                                            data-id="{{ row.record.id }}" 
                                            data-field="{{ column.name }}"
                                            data-placeholder="Click to add {{ column.verbose_name|lower }}"
                                            onblur="saveField(this)"
                                            onkeydown="handleKeyDown(this, event)"
                                        >
                                            {{ cell|default_if_none:''|safe }}
                                            <!-- Edit Icon -->
                                            <i class="fa fa-pencil-alt absolute right-0 top-0 mt-1 mr-2 text-gray-400 opacity-0 transition-opacity duration-200 editable-icon"></i>
                                        </span>
                                    {% elif column.name == 'customer_journey' %}
                                        <!-- Customer Journey Dropdown -->
                                        <select name="customer_journey" class="customer-journey-dropdown bg-gray-700 text-gray-200 rounded"
                                            data-id="{{ row.record.id }}" data-field="customer_journey" onchange="saveField(this)">
                                            <option value="Awareness" {% if cell == 'Awareness' %}selected{% endif %}>Awareness</option>
                                            <option value="Consideration" {% if cell == 'Consideration' %}selected{% endif %}>Consideration</option>
                                            <option value="Decision" {% if cell == 'Decision' %}selected{% endif %}>Decision</option>
                                            <option value="Retention" {% if cell == 'Retention' %}selected{% endif %}>Retention</option>
                                        </select>
                                    {% elif column.name == 'serp_content_type' %}
                                        <!-- SERP Content Type Dropdown -->
                                        <select name="serp_content_type" class="serp-content-type-dropdown bg-gray-700 text-gray-200 rounded"
                                            data-id="{{ row.record.id }}" data-field="serp_content_type" onchange="saveField(this)">
                                            <option value="Amazon Product Page" {% if cell == 'Amazon Product Page' %}selected{% endif %}>Amazon Product Page</option>
                                            <option value="Blog Category" {% if cell == 'Blog Category' %}selected{% endif %}>Blog Category</option>
                                            <option value="Blog Post" {% if cell == 'Blog Post' %}selected{% endif %}>Blog Post</option>
                                            <option value="Citation Site" {% if cell == 'Citation Site' %}selected{% endif %}>Citation Site</option>
                                            <option value="Homepage" {% if cell == 'Homepage' %}selected{% endif %}>Homepage</option>
                                            <option value="Lead Generation" {% if cell == 'Lead Generation' %}selected{% endif %}>Lead Generation</option>
                                            <option value="Local Lander" {% if cell == 'Local Lander' %}selected{% endif %}>Local Lander</option>
                                            <option value="Product Category" {% if cell == 'Product Category' %}selected{% endif %}>Product Category</option>
                                            <option value="Product Page" {% if cell == 'Product Page' %}selected{% endif %}>Product Page</option>
                                            <option value="Resource Guide" {% if cell == 'Resource Guide' %}selected{% endif %}>Resource Guide</option>
                                            <option value="Review Site" {% if cell == 'Review Site' %}selected{% endif %}>Review Site</option>
                                            <option value="Site Info" {% if cell == 'Site Info' %}selected{% endif %}>Site Info</option>
                                            <option value="YouTube Video" {% if cell == 'YouTube Video' %}selected{% endif %}>YouTube Video</option>
                                            <option value="Pinterest Page" {% if cell == 'Pinterest Page' %}selected{% endif %}>Pinterest Page</option>
                                            <option value="Wikipedia" {% if cell == 'Wikipedia' %}selected{% endif %}>Wikipedia</option>
                                        </select>
                                    {% else %}
                                        {{ cell|safe }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="mt-4">
            {% if table.page.paginator.num_pages > 1 %}
                <ul class="pagination flex justify-center items-center space-x-2">
                    <!-- Previous Button -->
                    {% if table.page.has_previous %}
                        <li>
                            <a href="?page={{ table.page.previous_page_number }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Previous</a>
                        </li>
                    {% else %}
                        <li>
                            <span class="px-4 py-2 bg-gray-700 text-gray-400 rounded">Previous</span>
                        </li>
                    {% endif %}

                    <!-- Page Numbers -->
                    {% for num in table.page.paginator.page_range %}
                        {% if num >= table.page.number|add:'-2' and num <= table.page.number|add:'2' %}
                            {% if num == table.page.number %}
                                <li>
                                    <span class="px-4 py-2 bg-gray-900 text-gray-200 rounded">{{ num }}</span>
                                </li>
                            {% else %}
                                <li>
                                    <a href="?page={{ num }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    <!-- Next Button -->
                    {% if table.page.has_next %}
                        <li>
                            <a href="?page={{ table.page.next_page_number }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Next</a>
                        </li>
                    {% else %}
                        <li>
                            <span class="px-4 py-2 bg-gray-700 text-gray-400 rounded">Next</span>
                        </li>
                    {% endif %}
                </ul>
            {% endif %}
        </div>
    </div>

    <!-- Link to the external JS file -->
    <script src="{% static 'js/keyword_research.js' %}"></script>
{% endblock %}
