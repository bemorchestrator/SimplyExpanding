<!-- keyword_research.html -->
{% extends 'base.html' %}
{% load render_table from django_tables2 %}

{% block content %}
    <!-- Include Font Awesome for Edit Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-yH2Br+HtIsVJzObX5fNRb/Ot7DRSuhxSjE6lE6FVHIbvc6im1cB/3H0tUv0D4OmGiDhZyVY3cXkGgFum0BvBtA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <div class="container mx-auto px-4 py-8">
        <h2 class="text-xl font-bold mb-4 text-white">Keyword Research Table</h2>

        <!-- Rows per page dropdown -->
        <form method="GET">
            <div class="flex justify-end mb-4">
                <label for="per_page" class="mr-2 text-white">Rows per page:</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="bg-gray-700 text-gray-200 rounded">
                    {% for option in per_page_options %}
                        <option value="{{ option }}" {% if per_page == option|stringformat:"s" %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>

        <!-- Table Rendering -->
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto">
                <thead>
                    <tr>
                        {% for column in table.columns %}
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-200 
                                       {% if column.name in 'action_choice url' %} sticky left-0 z-10 bg-gray-800 {% endif %} whitespace-nowrap">
                                {{ column.header }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table.page.object_list %}
                        <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                            {% for column, cell in row.items %}
                                <td class="px-6 py-4 text-sm text-gray-200 
                                           {% if column.name in 'action_choice url' %} sticky left-0 z-10 bg-gray-800 {% endif %} whitespace-nowrap relative">
                                    {% if column.name in 'primary_keyword pk_volume pk_ranking' %}
                                        <span
                                            class="editable-span single-line bg-transparent text-gray-200 focus:outline-none relative inline-block"
                                            contenteditable="true"
                                            data-id="{{ row.record.id }}" 
                                            data-field="{{ column.name }}"
                                            data-placeholder="Click to add {{ column.verbose_name|lower }}"
                                            onblur="saveField(this)"
                                            onkeydown="handleKeyDown(this, event)"
                                        >
                                            {{ cell|default_if_none:''|safe }}
                                            <!-- Edit Icon -->
                                            <i class="fa fa-pencil-alt absolute right-0 top-0 mt-1 mr-2 text-gray-400 opacity-0 transition-opacity duration-200 editable-icon"></i>
                                        </span>
                                    {% elif column.name == 'secondary_keywords' %}
                                        <span
                                            class="editable-span multi-line bg-transparent text-gray-200 focus:outline-none relative inline-block"
                                            contenteditable="true"
                                            data-id="{{ row.record.id }}" 
                                            data-field="{{ column.name }}"
                                            data-placeholder="Click to add {{ column.verbose_name|lower }}"
                                            onblur="saveField(this)"
                                            onkeydown="handleKeyDown(this, event)"
                                        >
                                            {{ cell|default_if_none:''|safe }}
                                            <!-- Edit Icon -->
                                            <i class="fa fa-pencil-alt absolute right-0 top-0 mt-1 mr-2 text-gray-400 opacity-0 transition-opacity duration-200 editable-icon"></i>
                                        </span>
                                    {% else %}
                                        {{ cell|safe }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="mt-4">
            {% if table.page.paginator.num_pages > 1 %}
                <ul class="pagination flex justify-center items-center space-x-2">
                    <!-- Previous Button -->
                    {% if table.page.has_previous %}
                        <li>
                            <a href="?page={{ table.page.previous_page_number }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Previous</a>
                        </li>
                    {% else %}
                        <li>
                            <span class="px-4 py-2 bg-gray-700 text-gray-400 rounded">Previous</span>
                        </li>
                    {% endif %}

                    <!-- Page Numbers -->
                    {% for num in table.page.paginator.page_range %}
                        {% if num >= table.page.number|add:'-2' and num <= table.page.number|add:'2' %}
                            {% if num == table.page.number %}
                                <li>
                                    <span class="px-4 py-2 bg-gray-900 text-gray-200 rounded">{{ num }}</span>
                                </li>
                            {% else %}
                                <li>
                                    <a href="?page={{ num }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    <!-- Next Button -->
                    {% if table.page.has_next %}
                        <li>
                            <a href="?page={{ table.page.next_page_number }}{% if base_query_string %}&{{ base_query_string }}{% endif %}" class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Next</a>
                        </li>
                    {% else %}
                        <li>
                            <span class="px-4 py-2 bg-gray-700 text-gray-400 rounded">Next</span>
                        </li>
                    {% endif %}
                </ul>
            {% endif %}
        </div>
    </div>

<!-- Inline Editing Script -->
<script>
    // Function to save the field
function saveField(element) {
    const id = element.dataset.id;        // Get the row ID
    const field = element.dataset.field;  // Get the field name
    let value;

    if (element.classList.contains('multi-line')) {
        // For multi-line fields, get text content, preserving line breaks
        value = element.innerText.trim();
    } else {
        // For single-line fields, get text content
        value = element.textContent.trim();
    }

    // Field-specific validation
    if (field === 'pk_volume' || field === 'pk_ranking') {
        if (value === '') {
            value = null;  // Allow empty value to set as null
        } else if (!/^\d+$/.test(value)) {  // Simple integer validation
            alert('Please enter a valid number.');
            element.focus();  // Optionally, revert to previous value or keep editing
            return;
        } else {
            value = parseInt(value, 10);
        }
    }

    // Remove editing highlight
    element.classList.remove('editing');

    fetch("{% url 'keyword_research' %}", {  // Ensure this URL name matches your urls.py
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'  // Ensure AJAX request is identified
        },
        body: JSON.stringify({
            'id': id,
            'value': value,
            'action': 'update',
            'field': field
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(field + ' updated successfully');
            // Replace newline characters with <br> for multi-line fields
            if (field === 'secondary_keywords') {
                element.innerHTML = value ? value.replace(/\n/g, '<br>') : '';
            } else {
                element.innerHTML = value || '';
            }
        } else {
            console.error('Failed to update ' + field + ':', data.error);
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An unexpected error occurred.');
    });
}

// Function to handle keydown events
function handleKeyDown(element, event) {
    const field = element.dataset.field;
    if (field === 'secondary_keywords') {
        if (event.altKey && event.key === "Enter") {
            event.preventDefault();  // Prevent default behavior
            // Insert line break at cursor position
            document.execCommand('insertText', false, '\n');
        } else if (event.key === "Enter") {
            event.preventDefault(); // Prevent default Enter key behavior
        }
    } else {
        if (event.key === "Enter") {
            event.preventDefault();  // Prevent inserting a newline
            element.blur();          // Trigger onblur to save the data
        }
    }
}

// Function to adjust the height of the editable span
function adjustHeight(element) {
    if (element.classList.contains('multi-line')) {
        element.style.height = 'auto';  // Reset the height to auto
    }
}

// Add event listeners for editable spans
document.addEventListener('DOMContentLoaded', function() {
    const editableSpans = document.querySelectorAll('.editable-span');

    editableSpans.forEach(span => {
        // Show edit icon on hover
        span.addEventListener('mouseenter', () => {
            const icon = span.querySelector('.editable-icon');
            if (icon) {
                icon.style.opacity = '1';
            }
        });

        span.addEventListener('mouseleave', () => {
            const icon = span.querySelector('.editable-icon');
            if (icon && !span.classList.contains('editing')) {
                icon.style.opacity = '0';
            }
        });

        // Highlight the span when editing
        span.addEventListener('focus', () => {
            span.classList.add('editing');
            const icon = span.querySelector('.editable-icon');
            if (icon) {
                icon.style.opacity = '0';
            }

            // Remove extra empty elements
            if (span.classList.contains('multi-line')) {
                span.innerHTML = span.innerHTML.replace(/<br>/gi, '');
            }

            adjustHeight(span);
        });

        span.addEventListener('blur', () => {
            span.classList.remove('editing');
            const icon = span.querySelector('.editable-icon');
            if (icon) {
                icon.style.opacity = '0';
            }

            // Clean up extra empty lines
            if (span.classList.contains('multi-line')) {
                span.innerHTML = span.innerHTML.trim().replace(/(<br>\s*)+$/, '');
            }

            adjustHeight(span);
        });

        // Adjust height on input for multi-line fields
        span.addEventListener('input', () => {
            if (span.classList.contains('multi-line')) {
                adjustHeight(span);
            }
        });

        // Adjust height based on initial content
        if (span.classList.contains('multi-line')) {
            adjustHeight(span);
        }
    });
});

</script>

<!-- Inline Styles for Editable Cells -->
<style>
    /* Editable Span Initial State */
    .editable-span {
        cursor: pointer;
        position: relative;
        padding: 2px 4px; /* Compact padding for single-line appearance */
        border-radius: 8px; /* Rounded edges */
        transition: background-color 0.3s ease, border 0.3s ease;
        display: inline-block;
        max-width: 100%; /* Ensure it doesn't exceed cell width */
        box-sizing: border-box;
        background-color: transparent; /* Default background (transparent) */
        min-width: 150px; /* Set a consistent minimum width */
    }

    /* Editable Span for Single-line Fields */
    .editable-span.single-line {
        white-space: nowrap; /* Prevent wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Editable Span for Multi-line Field (Secondary Keywords) */
    .editable-span.multi-line {
        display: block;
        white-space: pre-wrap; /* Allow line breaks for multi-line content */
        word-break: break-word; /* Prevent long words from overflowing */
        min-height: 1.5em; /* Default single line height */
        background-color: #2d3748; /* Tailwind Gray-800 background for multi-line */
        min-width: 150px; /* Set consistent minimum width for multi-line */
        padding: 4px; /* Add padding */
    }

    /* Editable Span Expansion for Multi-line Fields (Editing Mode) */
    .editable-span.multi-line.editing {
        overflow-y: auto; /* Adds scroll if content exceeds available height */
        background-color: #4a5568; /* Darker gray background when editing */
    }

    /* Editable Span for Single-line Fields (Primary Keyword, PK Volume, PK Ranking) */
    .editable-span.single-line.editing {
        background-color: #4a5568; /* Tailwind Gray-700 background for single-line fields when editing */
    }

    /* Highlight Editing State */
    .editable-span.editing {
        background-color: #4a5568; /* Tailwind Gray-700 background when editing */
        border-radius: 8px; /* Rounded corners when editing */
    }

    /* Edit Icon Styling */
    .editable-icon {
        pointer-events: none; /* Allows clicks to pass through to the span */
        transition: opacity 0.2s ease;
    }

    /* Show the edit icon when the span is hovered and not editing */
    .editable-span:hover .editable-icon {
        opacity: 1;
    }

    /* Placeholder Styling */
    .editable-span:empty:before {
        content: attr(data-placeholder);
        color: #a0aec0; /* Tailwind Gray-400 */
        pointer-events: none;
    }

    /* Ensure placeholder is hidden when editing or not empty */
    .editable-span.editing:empty:before,
    .editable-span:not(:empty):before {
        content: "";
    }

    /* Adjust table cell to accommodate multi-line content */
    td {
        vertical-align: top;
    }

    /* Adjust the overall table row to be compact */
    table tr td {
        padding: 0.5em 1em; /* Reduce padding to compact the row height */
        vertical-align: top; /* Ensure top alignment of text */
        white-space: nowrap; /* Prevent long text from expanding the cell height */
        overflow: hidden; /* Hide overflow text */
        text-overflow: ellipsis; /* Use ellipsis for overflowed text */
    }

    /* Add gray background to table rows */
    table tr {
        background-color: #1a202c; /* Tailwind Gray-900 background for rows */
        transition: background-color 0.3s ease; /* Smooth background transition */
    }

    /* Add hover effect for table rows */
    table tr:hover {
        background-color: #2d3748; /* Tailwind Gray-800 background on hover */
    }

    /* Add gray background to sticky columns (like URL) */
    table tr td.sticky {
        background-color: #2d3748; /* Tailwind Gray-800 background for sticky columns */
    }

    /* Gray backgrounds for Primary Keyword, PK Volume, PK Ranking, and Secondary Keywords */
    .editable-span[data-field="primary_keyword"],
    .editable-span[data-field="pk_volume"],
    .editable-span[data-field="pk_ranking"],
    .editable-span[data-field="secondary_keywords"] {
        background-color: #2d3748; /* Tailwind Gray-800 background */
        min-width: 150px; /* Set consistent minimum width */
    }

    .editable-span[data-field="primary_keyword"].editing,
    .editable-span[data-field="pk_volume"].editing,
    .editable-span[data-field="pk_ranking"].editing,
    .editable-span[data-field="secondary_keywords"].editing {
        background-color: #4a5568; /* Darker Tailwind Gray-700 background when editing */
    }

    /* Pagination Styles */
    .pagination li a, .pagination li span {
        display: block;
        padding: 0.5rem 0.75rem;
        margin: 0 0.25rem;
        text-decoration: none;
        border-radius: 0.375rem; /* Rounded corners */
    }
    .pagination li a:hover {
        background-color: #4a5568; /* Tailwind Gray-700 on hover */
        color: #fff;
    }
    .pagination li span {
        background-color: #2d3748; /* Tailwind Gray-800 for current page */
        color: #fff;
    }

</style>
  
{% endblock %}
