{% extends 'base.html' %}

{% load render_table from django_tables2 %}

{% block content %}
<div class="mt-10 px-8 h-screen flex flex-col">
    <div class="bg-gray-800 rounded px-8 py-6 flex-1 flex flex-col">

        <!-- Header Section -->
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-xl font-semibold text-white">Website Audit Dashboard</h2>

            <!-- Search Bar and Action Buttons -->
            <div class="flex items-center space-x-4">
                <!-- Search Bar -->
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search..."
                    value="{{ search_query }}"
                    class="px-4 py-2 rounded border border-gray-300 text-black"
                />

                <!-- Upload Button -->
                <button id="upload-btn" class="bg-green-500 text-white py-2 px-4 rounded">
                    <i class="bi bi-upload"></i>
                </button>

                <!-- Crawl Sitemap -->
                <form action="/audit/crawl-sitemaps/" method="POST">
                    {% csrf_token %}
                    <button type="submit" id="upload-btn" class="bg-indigo-500 text-white py-2 px-4 rounded">
                        <i class="bi bi-bug"></i>
                    </button>
                </form>

                <!-- Delete Button -->
                <button id="delete-all-btn" class="bg-red-500 text-white py-2 px-4 rounded">
                    <i class="bi bi-trash"></i>
                </button>

                <!-- Filter Button -->
                <div class="relative">
                    <button id="filter-toggle-btn" class="bg-blue-500 text-white py-2 px-4 rounded">
                        <i class="bi bi-funnel"></i>
                    </button>

                    <!-- Filter Dropdown -->
                    <div id="filter-dropdown" class="hidden absolute right-0 bg-gray-700 p-4 mt-2 rounded shadow-lg w-96 z-50 max-h-96 overflow-y-auto">
                        <form method="GET" class="space-y-4">
                            <!-- Group 1: Basic Information Filters -->
                            <div class="p-4 rounded">
                                <h3 class="text-white text-lg font-semibold">Basic Information</h3>
                                <div class="space-y-2">
                                    <div>
                                        {{ filter.form.url.label_tag }}
                                        <input class="text-black w-full" type="text" name="url" value="{{ filter.form.url.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.page_path.label_tag }}
                                        <input class="text-black w-full" type="text" name="page_path" value="{{ filter.form.page_path.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.crawl_depth.label_tag }}
                                        <input class="text-black w-full" type="text" name="crawl_depth" value="{{ filter.form.crawl_depth.value }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Group 2: Keyword Filters -->
                            <div class="p-4 rounded">
                                <h3 class="text-white text-lg font-semibold">Keyword Information</h3>
                                <div class="space-y-2">
                                    <div>
                                        {{ filter.form.main_kw.label_tag }}
                                        <input class="text-black w-full" type="text" name="main_kw" value="{{ filter.form.main_kw.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.kw_volume.label_tag }}
                                        <input class="text-black w-full" type="text" name="kw_volume" value="{{ filter.form.kw_volume.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.kw_ranking.label_tag }}
                                        <input class="text-black w-full" type="text" name="kw_ranking" value="{{ filter.form.kw_ranking.value }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Group 3: Other Filters -->
                            <div class="p-4 rounded">
                                <h3 class="text-white text-lg font-semibold">Other Information</h3>
                                <div class="space-y-2">
                                    <div>
                                        {{ filter.form.category.label_tag }}
                                        <input class="text-black w-full" type="text" name="category" value="{{ filter.form.category.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.status_code.label_tag }}
                                        <input class="text-black w-full" type="text" name="status_code" value="{{ filter.form.status_code.value }}">
                                    </div>
                                    <div>
                                        {{ filter.form.action_choice.label_tag }}
                                        <input class="text-black w-full" type="text" name="action_choice" value="{{ filter.form.action_choice.value }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Filter Button -->
                            <div class="mt-4">
                                <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded w-full">Apply Filters</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Rendering using django-tables2 -->
        <div class="table-container overflow-x-auto overflow-y-auto flex-1">
            {% render_table audit_data %}
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls mt-4 flex items-center space-x-4">
            <span id="pagination-info-bottom">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_previous %}
                <a href="?page=1&search={{ search_query }}" class="bg-blue-500 text-white px-4 py-2 rounded">First</a>
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}" class="bg-blue-500 text-white px-4 py-2 rounded">Previous</a>
            {% endif %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}" class="bg-blue-500 text-white px-4 py-2 rounded">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}" class="bg-blue-500 text-white px-4 py-2 rounded">Last</a>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Ensure all table cells have nowrap and align properly */
    table th, table td {
        white-space: nowrap;
        text-align: left;
        padding-left: 1rem; /* Add padding to each cell */
        padding-right: 1rem; /* Add padding to each cell */
        border: none; /* Ensure there is no border around the cells */
    }

    /* Ensure no gaps between cells and collapse borders */
    table {
        border-collapse: collapse; /* This removes gaps between cells */
    }

    /* Style sticky columns and headers */
    .sticky-col-1, .sticky-col-2 {
        position: sticky;
        background-color: #2d3748; /* Keep sticky column background consistent */
        z-index: 1;
        min-height: 100px; /* Ensure sticky columns have a minimum height */
    }

    /* First column (Actions) */
    .sticky-col-1 {
        left: 0;
        width: 150px; /* Set width for the first column */
        min-height: 100px; /* Ensure the background color extends even when no data */
    }

    /* Second column (URL) */
    .sticky-col-2 {
        left: 152px; /* Ensure there is no overlap with the first column */
        width: 300px; /* Adjust the width of the second column if needed */
        min-height: 100px; /* Ensure the background color extends even when no data */
    }

    /* Page Path column (non-sticky) */
    .page-path {
        min-width: 200px; /* Set a minimum width to ensure no overlap */
        padding-left: 50px; /* Adds a gap between the URL and Page Path headers */
    }

    /* Ensure headers for sticky columns are also sticky */
    th.sticky-col-1, th.sticky-col-2 {
        position: sticky;
        top: 0; /* Keep the header at the top */
        background-color: #2d3748; /* Match header background with sticky columns */
        z-index: 2; /* Higher z-index to keep header above the data */
    }

    /* Adjust the second sticky column header (URL) */
    th.sticky-col-2 {
        left: 152px; /* Ensure no overlap with the first column */
    }

    /* Adjust the Page Path header */
    th.page-path {
        padding-left: 50px; /* Add a gap between URL and Page Path headers */
    }

</style>


<!-- SweetAlert2 script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete All Button Functionality
        const deleteBtn = document.getElementById('delete-all-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function(event) {
                event.preventDefault();
                console.log("Delete button clicked.");

                Swal.fire({
                    title: 'Are you sure?',
                    text: "This action will delete all uploaded data!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log("User confirmed deletion.");
                        const csrftoken = getCookie('csrftoken');
                        
                        // Make an AJAX request to delete data
                        fetch("{% url 'delete_uploaded_files' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                Swal.fire(
                                    'Deleted!',
                                    'All data has been deleted.',
                                    'success'
                                ).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Error!',
                                    data.error || 'There was an issue deleting the data.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'There was an issue deleting the data.',
                                'error'
                            );
                        });
                    }
                });
            });
        }

        // Function to change color of the dropdown based on selected option
        function changeColor(selectElement) {
            const colorMap = {
                'text-blue-500': '#3B82F6',
                'text-green-500': '#10B981',
                'text-yellow-500': '#F59E0B',
                'text-red-500': '#EF4444',
                'text-purple-500': '#8B5CF6',
                'text-pink-500': '#EC4899',
                'text-indigo-500': '#6366F1',
                'text-teal-500': '#14B8A6',
                'text-orange-500': '#F97316',
            };

            selectElement.classList.remove(
                "text-blue-500", 
                "text-green-500", 
                "text-yellow-500", 
                "text-red-500", 
                "text-purple-500", 
                "text-pink-500", 
                "text-indigo-500", 
                "text-teal-500", 
                "text-orange-500"
            );

            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const selectedClass = selectedOption.classList[0];

            if (selectedClass) {
                selectElement.classList.add(selectedClass);
            }

            selectElement.style.backgroundColor = colorMap[selectedClass] || '#253140';
        }

        // Attach changeColor function to all dropdowns
        function attachDropdownListeners() {
            document.querySelectorAll('.action-dropdown').forEach(function(selectElement) {
                changeColor(selectElement);

                selectElement.addEventListener('change', function() {
                    changeColor(this);
                    const auditId = this.getAttribute('data-id');
                    const selectedAction = this.value;
                    const csrftoken = getCookie('csrftoken');

                    // Make AJAX POST request to update action choice
                    fetch("{% url 'update_action_choice' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: JSON.stringify({
                            'id': auditId,
                            'action_choice': selectedAction
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            Swal.fire(
                                'Error!',
                                data.error || 'There was an issue updating the action choice.',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        Swal.fire(
                            'Error!',
                            'There was an issue updating the action choice.',
                            'error'
                        );
                    });
                });
            });
        }
        attachDropdownListeners();

        // Upload Button Click Event
        const uploadBtn = document.getElementById('upload-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function () {
                window.location.href = "{% url 'upload_file' %}";
            });
        }

        // Search Functionality
        const searchInput = document.getElementById('search-input');
        let searchTimeout = null;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // Function to perform AJAX search
        function performSearch(query) {
            const params = new URLSearchParams({
                search: query,
            });

            fetch(`?${params.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                updateTable(data.audit_data);
                updatePagination(data.current_page, data.num_pages, data.has_previous, data.has_next);
            })
            .catch(error => console.error('Error during search:', error));
        }

        // Function to update the table body with new data
        function updateTable(auditData) {
            const tableBody = document.getElementById('audit-table-body');
            tableBody.innerHTML = '';

            auditData.forEach(row => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-700');
                
                const tdActions = createDropdownTd(row);
                const tdUrl = createUrlTd(row);
                const tdCrawlDepth = createSimpleTd(row.crawl_depth);
                const tdCategory = createSimpleTd(row.category);

                tr.append(tdActions, tdUrl, tdCrawlDepth, tdCategory);
                tableBody.appendChild(tr);
            });

            attachDropdownListeners();
        }

        // Create Table Data for Dropdown
        function createDropdownTd(row) {
            const td = document.createElement('td');
            td.classList.add('py-1', 'px-2', 'text-left', 'whitespace-nowrap', 'sticky-col-1');
            td.style.backgroundColor = '#253140';

            const select = document.createElement('select');
            select.classList.add('shadow', 'border', 'rounded', 'w-32', 'py-1', 'text-white', 'action-dropdown');
            select.setAttribute('data-id', row.id);

            const actions = [
                { value: 'leave', text: '1. Leave As Is', class: 'text-blue-500' },
                { value: 'update_on_page', text: '2. Update "On Page"', class: 'text-green-500' },
                { value: '301', text: '4. 301', class: 'text-red-500' },
            ];

            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.value;
                option.textContent = action.text;
                option.classList.add(action.class);
                if (row.action_choice === action.value) option.selected = true;
                select.appendChild(option);
            });

            td.appendChild(select);
            return td;
        }

        // Create Simple Table Data for URL
        function createUrlTd(row) {
            const td = document.createElement('td');
            td.classList.add('py-1', 'px-2', 'text-left', 'whitespace-nowrap', 'sticky-col-2');
            td.style.backgroundColor = '#253140';

            const span = document.createElement('span');
            span.style.maxWidth = '400px';
            span.style.whiteSpace = 'nowrap';
            span.textContent = row.url;
            td.appendChild(span);

            return td;
        }

        function createSimpleTd(text) {
            const td = document.createElement('td');
            td.classList.add('py-1', 'px-2', 'text-left', 'whitespace-nowrap');
            td.textContent = text;
            return td;
        }

        // Function to update pagination controls
        function updatePagination(currentPage, numPages, hasPrevious, hasNext) {
            const paginationInfo = document.getElementById('pagination-info-bottom');
            paginationInfo.textContent = `Page ${currentPage} of ${numPages}`;

            const firstBtn = document.querySelector('button[onclick*="page=1"]');
            const prevBtn = document.querySelector('button[onclick*="previous_page_number"]');
            const nextBtn = document.querySelector('button[onclick*="next_page_number"]');
            const lastBtn = document.querySelector('button[onclick*="paginator.num_pages"]');

            setButtonState(firstBtn, currentPage !== 1);
            setButtonState(prevBtn, hasPrevious);
            setButtonState(nextBtn, hasNext);
            setButtonState(lastBtn, currentPage !== numPages);
        }

        function setButtonState(button, condition) {
            if (button) button.disabled = !condition;
        }

        // Cookie function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });

    document.getElementById('filter-toggle-btn').addEventListener('click', function() {
        const dropdown = document.getElementById('filter-dropdown');
        dropdown.classList.toggle('hidden');
    });

    // Optionally, close the dropdown if the user clicks outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('filter-dropdown');
        const button = document.getElementById('filter-toggle-btn');
        if (!button.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });
</script>

{% endblock %}